<html>
<head>
    <meta http-equiv="Content-Type" content="text/html; charset=UTF-8">
    <title>简易随机抽奖DApp</title>
    <link href="index.css" rel="stylesheet" type="text/css" />
    <script src="index.js"></script>
    <!-- <script src="app.js"></script> -->
    <!-- <pre style="width: 100%; height: 100%; margin:0px; "></pre> -->
    <script src='eosjs/dist-web/eosjs-api.js'></script>
    <script src='eosjs/dist-web/eosjs-jsonrpc.js'></script>
    <!-- <script src='eosjs/dist-web/eosjs-rpcerror-debug.js'></script> -->
    <script src='eosjs/dist-web/eosjs-jssig.js'></script>
    <script>
        privateKey_pa   ="PW5KfKXy8qXD3JbKZ3RosqS6PYfm9eBjx2mHveVm4T4dfz7d4LrFE";
        // defaultPrivateKey="5KjiKSVyFEnR8rr2TmxMZBDSrvp45LVX9BSyseEFsVBtruaGGXg";
        vanelOwnerKey   ="5K9U98d63o1z9YXXgBE8uCVvF7co8Tdp6VoywKhv9bg4N3iokxQ";
        vanelActiveKey  ="5KjiKSVyFEnR8rr2TmxMZBDSrvp45LVX9BSyseEFsVBtruaGGXg";
        const rpc = new eosjs_jsonrpc.default('http://127.0.0.1:8888');
        const signatureProvider = new eosjs_jssig.default([vanelActiveKey]);
        const api = new eosjs_api.default({ rpc, signatureProvider });
        function pushAction(actionName, dataValue){
            (async () => {
                try {
                    const result = await api.transact({
                        actions: [{
                            account: 'pa',
                            name: actionName,
                            authorization: [{
                                actor: 'vanel',
                                permission: 'active',
                            }],
                            data: dataValue,
                        }]
                        }, {
                        blocksBehind: 3,
                        expireSeconds: 30,
                    });
                    var console_output = result.processed.action_traces[0].console;
                    var operate_output = console_output.replace(/Id/g,"<strong>主奖项编号</strong>");
                    var operate_output = operate_output.replace(/Name/g,"<strong>奖项名称</strong>");
                    var operate_output = operate_output.replace(/Items/g,"子奖项");
                    var operate_output = operate_output.replace(/id:/g,"  编号：");
                    var operate_output = operate_output.replace(/context:/g,"  内容：");
                    var operate_output = operate_output.replace(/winners' number:/g,"  获奖人数：");
                    var operate_output = operate_output.replace(/winners:/g,"  获奖者：");
                    var surprise_prjs = console_output.split("|||");
                    var surprise_prjs_operate = operate_output.split("|||");
                    var pris_num = surprise_prjs.length;
                    let blockchainText = "";
                    let operateText = "";
                    // document.getElementById("blockchain_output").innerHTML = console_output;
                    for(var i=1; i<pris_num; i++){
                        blockchainText += "<p>" + surprise_prjs[i] + "</p>";
                        var surprise_items = surprise_prjs[i].split("||-");
                        var surprise_items_operate = surprise_prjs_operate[i].split("||-");
                        for(var j=0; j<surprise_items_operate.length; j++){
                            if(j>1){
                                operateText += "<p>" +"&nbsp&nbsp&nbsp&nbsp&nbsp&nbsp&nbsp";
                                var iteminfo = surprise_items_operate[j].split("|-");
                                operateText += iteminfo[0] +"</p>"+"<p>"+"&nbsp&nbsp&nbsp&nbsp&nbsp&nbsp&nbsp&nbsp&nbsp&nbsp&nbsp&nbsp&nbsp&nbsp"+ iteminfo[1] +"</p>";
                            }else{
                                operateText += surprise_items_operate[j];
                            }
                        }
                    }
                    operateText = operateText.replace(/Undefined/g,"暂未设置");
                    operateText = operateText.replace(/undefined/g,"");
                    operateText = operateText.replace(/not generated yet/g,"未产生");
                    document.getElementById("blockchain_output").innerHTML = blockchainText;
                    document.getElementById("operate_output").innerHTML = operateText;
                } catch (e) {
                    var err_info = '\nCaught exception: ' + e;
                    if (e instanceof eosjs_jsonrpc.RpcError)
                        err_info += '\n\n' + JSON.stringify(e.json, null, 2);
                    alert(err_info);
                    // throw(err);
                }
            })();
        }
        function showInfo(){
            pushAction("showinfo",{});
        }
        function checkN(){
            var checkNumberValue = document.getElementById("check_number").value;
            pushAction("checkn",{author:"vanel", number:checkNumberValue});
        }
        function checkById(){
            var idValue = document.getElementById("check_id").value;
            pushAction("checkbyid",{author:"vanel", project_id:idValue});
        }

    </script>
</head>

<body> <!-- onload="checkCookie()" -->
    <div>
        <h1 id="title" class="title">随机抽奖系统</h1>
        <div id="panel_show">
            <p id="label1">
                <strong>Console output from EOS BlockChain:</strong><hr />
            </p>
            <code id="blockchain_output"></code>
        </div>
        <hr />
        <p>
            <button type="button" onclick="showInfo()">showinfo</button>
        </p>
        <p>
            输入你要查询的历史记录数目：
            <input type="text" id="check_number" class="number_text">
            <button type="button" onclick="checkN()">checkn</button>
        </p>
        <p>
            输入你要查询的记录的主奖项ID：
            <input type="text" id="check_id" class="number_text">
            <button type="button" onclick="checkById()">checkbyid</button>
        </p>
        <p>
            输入你要<strong>新建</strong>的<strong>抽奖项目</strong>名称：
            <input type="text" id="create_id" class="number_text">
            <button type="button" onclick="createPrj()">create</button>
        </p>
        要添加到主奖项ID：<input type="text" id="item_prj_id" class="number_text">
        子奖项ID：<input type="text" id="item_id" class="number_text">
        子奖项内容：<input type="text" id="item_context">
        <button type="button" onclick="addItem()">additem</button>
        <p>
            输入要添加到主奖项ID：<input type="text" id="cad_prj_id" class="number_text">
            子奖项ID：<input type="text" id="cad_item_id" class="number_text">
            参与者（名称或联系方式皆可）：
            <input type="text" id="cad_id">
            <button type="button" onclick="addCad()">addcad</button>
        </p>
        <hr />
        操作记录显示：
        <div id="operate_output">

        </div>

        <p><a href="https://github.com/treasersimplifies" target="_blank">The End</a></p>
        <p></p>
        <p></p>
        <p></p>
        <p></p>
    </div>
</body>
</html>
